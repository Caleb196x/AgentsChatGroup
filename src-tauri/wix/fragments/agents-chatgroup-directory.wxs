<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Fragment>
    <SetProperty
      Id="INSTALLDIR"
      Value="[INSTALLDIR]agents_chatgroup\"
      Before="CostFinalize"
    >
      NOT Installed
      AND NOT REMOVE
      AND NOT (INSTALLDIR ~&gt;&lt; "agents_chatgroup")
      AND NOT (INSTALLDIR ~&gt;&lt; "agents-chatgroup")
    </SetProperty>
  </Fragment>

  <Fragment>
    <!-- Remove all user data/cache on full uninstall (but keep data during upgrades). -->
    <CustomAction
      Id="CleanupAgentChatgroupData"
      Directory="INSTALLDIR"
      Execute="deferred"
      Impersonate="yes"
      ExeCommand="powershell.exe -NoProfile -NonInteractive -WindowStyle Hidden -ExecutionPolicy Bypass -Command &quot;$ErrorActionPreference = 'SilentlyContinue'; $workspaceRoot = $null; $configPaths = @((Join-Path $env:APPDATA 'agents-chatgroup\config.json'), (Join-Path $env:APPDATA 'ai\agents-chatgroup\config.json')); foreach ($configPath in $configPaths) { if (Test-Path -LiteralPath $configPath) { try { $config = Get-Content -LiteralPath $configPath -Raw | ConvertFrom-Json; if ($config.workspace_dir) { $workspaceRoot = Join-Path $config.workspace_dir '.agents-chatgroup-workspaces'; break } } catch {} } }; $paths = @((Join-Path $env:APPDATA 'agents-chatgroup'), (Join-Path $env:APPDATA 'ai\agents-chatgroup'), (Join-Path $env:LOCALAPPDATA 'utils'), (Join-Path $env:LOCALAPPDATA 'ai\utils'), (Join-Path $env:LOCALAPPDATA 'agents-chatgroup'), (Join-Path $env:LOCALAPPDATA 'ai\agents-chatgroup'), (Join-Path $env:TEMP 'agents-chatgroup'), (Join-Path $env:TEMP 'agents-chatgroup-dev')); if ($workspaceRoot) { $paths += $workspaceRoot }; foreach ($path in $paths) { if ($path -and (Test-Path -LiteralPath $path)) { Remove-Item -LiteralPath $path -Recurse -Force -ErrorAction SilentlyContinue } }&quot;"
      Return="ignore"
    />

    <InstallExecuteSequence>
      <Custom Action="CleanupAgentChatgroupData" Before="RemoveFiles">
        REMOVE="ALL" AND NOT UPGRADINGPRODUCTCODE
      </Custom>
    </InstallExecuteSequence>
  </Fragment>
</Wix>
